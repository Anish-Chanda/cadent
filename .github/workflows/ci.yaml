name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  unit-test-app:
    name: Flutter Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
      
      - name: Get Flutter dependencies
        working-directory: ./app
        run: flutter pub get
      
      - name: Analyze Flutter code
        working-directory: ./app
        run: flutter analyze --no-fatal-infos
      
      - name: Run Flutter tests
        working-directory: ./app
        run: |
          # Run tests
          flutter test
          # Generate machine-readable test output for sonar-flutter
          flutter test --machine --coverage > tests.output
      
      - name: Upload Flutter test artifacts
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v5
        with:
          name: flutter-test-data
          path: |
            app/coverage/lcov.info
            app/tests.output
          if-no-files-found: error
          retention-days: 1

  unit-test-backend:
    name: Go Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
      
      - name: Get Go dependencies
        working-directory: ./backend
        run: go mod download

      - name: Run Go vet
        working-directory: ./backend
        run: go vet ./...
      
      - name: Run Go tests, JSON and coverage
        working-directory: ./backend
        run: |
          go test -v ./... -json > report.json
          go test -coverprofile=coverage.out  ./...
      
      - name: Upload Go test artifacts
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v5
        with:
          name: go-test-data
          path: |
            backend/report.json
            backend/coverage.out
          if-no-files-found: error
          retention-days: 1

  e2e-test-api:
    name: End-to-End API Tests
    runs-on: ubuntu-latest
    needs: [unit-test-backend]
    
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: cadent_user
          POSTGRES_PASSWORD: cadent_password
          POSTGRES_DB: cadent_db
        options: >-
          --health-cmd "pg_isready -U cadent_user -d cadent_db"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    env:
      POSTGRES_DSN: "postgresql://cadent_user:cadent_password@localhost:5432/cadent_db?sslmode=disable"
      PORT: "8080"
      JWT_SECRET: "test-jwt-secret-key-for-ci-only"
      VALHALLA_URL: ""
      ENVIRONMENT: "test"
      LOG_LEVEL: "debug"
      AVATAR_PATH: "/app/avatars"
      BASE_URL: "http://localhost:8080"
      STORAGE_DSN: "local://./data"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Install hurl
        run: |
          curl -LO https://github.com/Orange-OpenSource/hurl/releases/download/7.1.0/hurl_7.1.0_amd64.deb
          sudo dpkg -i hurl_7.1.0_amd64.deb
      
      - name: Build API Docker image
        run: |
          docker build \
            --build-arg API_VERSION=ci-test \
            --build-arg BUILD_HASH=${{ github.sha }} \
            -t cadent-api:test \
            .
      
      - name: Start backend API container
        run: |
          docker run -d \
            --name cadent-api \
            --network host \
            -e POSTGRES_DSN="$POSTGRES_DSN" \
            -e PORT="$PORT" \
            -e JWT_SECRET="$JWT_SECRET" \
            -e VALHALLA_URL="$VALHALLA_URL" \
            -e ENVIRONMENT="$ENVIRONMENT" \
            -e LOG_LEVEL="$LOG_LEVEL" \
            -e AVATAR_PATH="$AVATAR_PATH" \
            -e BASE_URL="$BASE_URL" \
            -e STORAGE_DSN="$STORAGE_DSN" \
            cadent-api:test
          # Wait for API to be ready
          timeout 30 bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do sleep 1; done' || exit 1
      
      - name: Run E2E tests
        run: make test-e2e-api
      
      - name: Show API logs on failure
        if: failure()
        run: docker logs cadent-api
      
      - name: Stop backend API container
        if: always()
        run: docker rm -f cadent-api || true
  
  # Run SonarQube analysis only on pushes to main branch (skip when running locally with act)
  sonar-analysis:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !github.event.act
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [unit-test-app, e2e-test-api]
    permissions:
      contents: read
    
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
      
      - name: Flutter pub get for Sonar
        working-directory: ./app
        run: flutter pub get

      - name: Download Flutter test artifacts
        if: ${{ !env.ACT }}
        uses: actions/download-artifact@v6
        with:
          name: flutter-test-data
          path: app

      - name: Download Go test artifacts
        if: ${{ !env.ACT }}
        uses: actions/download-artifact@v6
        with:
          name: go-test-data
          path: backend
      
      - name: Prepare Flutter pubspec for Sonar
        run: cp app/pubspec.yaml pubspec.yaml

      - name: OWASP Dependency-Check
        if: ${{ !env.ACT }}
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: cadent
          path: '.'
          format: 'JSON'
          out: 'reports'
          args: >
            --format HTML
            --enableExperimental

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}