name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  unit-test-app:
    name: Flutter Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
      
      - name: Get Flutter dependencies
        working-directory: ./app
        run: flutter pub get
      
      - name: Analyze Flutter code
        working-directory: ./app
        run: flutter analyze --no-fatal-infos
      
      - name: Run Flutter tests
        working-directory: ./app
        run: |
          # Run tests
          flutter test
          # Generate machine-readable test output for sonar-flutter
          flutter test --machine --coverage > tests.output
      
      - name: Upload Flutter test artifacts
        uses: actions/upload-artifact@v5
        with:
          name: flutter-test-data
          path: |
            app/coverage/lcov.info
            app/tests.output
          if-no-files-found: error
          retention-days: 1

  unit-test-backend:
    name: Go Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
      
      - name: Get Go dependencies
        working-directory: ./backend
        run: go mod download

      - name: Run Go vet
        working-directory: ./backend
        run: go vet ./...
      
      - name: Run Go tests, JSON and coverage
        working-directory: ./backend
        run: |
          go test -v ./... -json > report.json
          go test -coverprofile=coverage.out  ./...
      
      - name: Upload Go test artifacts
        uses: actions/upload-artifact@v5
        with:
          name: go-test-data
          path: |
            backend/report.json
            backend/coverage.out
          if-no-files-found: error
          retention-days: 1
  
  # Run SonarQube analysis only on pushes to main branch
  sonar-analysis:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [unit-test-app, unit-test-backend]
    permissions:
      contents: read
    
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
      
      - name: Flutter pub get for Sonar
        working-directory: ./app
        run: flutter pub get

      - name: Download Flutter test artifacts
        uses: actions/download-artifact@v6
        with:
          name: flutter-test-data
          path: .  # keeps app/coverage/... and app/tests.output

      - name: Download Go test artifacts
        uses: actions/download-artifact@v6
        with:
          name: go-test-data
          path: .  # keeps backend/report.json and backend/coverage.out
      
      - name: Prepare Flutter pubspec for Sonar
        run: cp app/pubspec.yaml pubspec.yaml

      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: cadent
          path: '.'
          format: 'JSON'
          out: 'reports'
          args: >
            --format HTML
            --enableExperimental

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}